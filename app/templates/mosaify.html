<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Home</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .my-form {
        margin-bottom: 10px;
      }
    </style>
    <style>
      #drop-area-tilearea {
        border: 2px dashed #ccc;
        border-radius: 20px;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        text-align: center;
      }
      #upload-area-tilearea {
        border: 2px dashed #ccc;
        border-radius: 20px;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        text-align: center;
      }
      #drop-area-tilearea.highlight {
        border-color: purple;
      }
      #fileElem-tilearea {
        display: none;
      }
      #gallery-tilearea {
        margin-top: 10px;
      }
      #gallery-tilearea img {
        width: 150px;
        margin: 10px;
      }
    </style>
    <style>
      #drop-area-targetarea {
        border: 2px dashed #ccc;
        border-radius: 20px;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        text-align: center;
      }
      #upload-area-targetarea {
        border: 2px dashed #ccc;
        border-radius: 20px;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        text-align: center;
      }
      #drop-area-targetarea.highlight {
        border-color: purple;
      }
      #fileElem-targetarea {
        display: none;
      }
      #gallery-targetarea {
        margin-top: 10px;
      }
      #gallery-targetarea img {
        width: 150px;
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Welcome, {{ current_user.username }}!</h1>
    {% if current_project %}
    <h2>Current Project ID: {{ current_project.id }}</h2>
    {% else %}
    <h2>No current project selected.</h2>
    {% endif %}
    <br />
    <a href="{{ url_for('main.home') }}">Projects</a>
    <br />
    <!-- Start Tile Images -->
    <div>
      <h2>Upload Tile Images</h2>
      <form id="upload-form-tilearea" class="my-form">
        <div id="drop-area-tilearea">
          <p>Drag and drop Tile images here</p>
          <input
            type="file"
            id="fileElem-tilearea"
            name="files[]"
            multiple
            accept="image/*"
            onchange="handleTileAreaFiles(this.files)"
          />
          <input
            type="file"
            name="files[]"
            multiple
            accept="image/*"
            onchange="handleTileAreaFiles(this.files)"
          />
          <label class="button" for="fileElem-tilearea"></label>
        </div>
        <div id="upload-area-tilearea">
          <button type="button" onclick="uploadTileAreaFiles()">Upload</button>
          <div id="gallery-tilearea"></div>
        </div>
      </form>
      <div>
        <h1>Uploaded Tile Images</h1>
        {% for file in files %}
        <img
          src="{{ url_for('main.uploaded_tile_file', id=file) }}"
          alt="{{ file }}"
          style="max-width: 32px"
        />
        {% endfor %}
      </div>
      <br />
      <a href="{{ url_for('main.list_files') }}">List uploaded files</a>
    </div>
    <!-- End Tile Images -->

    <!-- Start Target Images -->
    <div>
      <h2>Upload The Target Image</h2>
      <form id="upload-form-targetarea" class="my-form">
        <div id="drop-area-targetarea">
          <p>Drag and drop Tile images here</p>
          <input
            type="file"
            id="fileElem-targetarea"
            name="files[]"
            accept="image/*"
            onchange="handleTargetAreaFiles(this.files)"
          />
          <input
            type="file"
            name="files[]"
            accept="image/*"
            onchange="handleTargetAreaFiles(this.files)"
          />
          <label class="button" for="fileElem-targetarea"></label>
        </div>
        <div id="upload-area-targetarea">
          <button type="button" onclick="uploadTargetAreaFiles()">
            Upload
          </button>
          <div id="gallery-targetarea"></div>
        </div>
      </form>
      <div>
        <h1>Uploaded Target Image</h1>
        {% for file in target_files %}
        <img
          src="{{ url_for('main.uploaded_target_file', id=file) }}"
          alt="{{ file }}"
          style="max-width: 64px"
        />
        {% endfor %}
      </div>
      <br />
      <!-- <a href="{{ url_for('main.list_files') }}">List uploaded files</a> -->
    </div>
    <!-- End Target Images -->

    <br />
    <a href="{{ url_for('main.mosaify_run') }}">Create Mosaic</a>
    <br />

    <!-- Start Tile Images -->
    <script>
      let dropArea_tilearea = document.getElementById("drop-area-tilearea");
      let filesToUpload_tilearea = [];

      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropArea_tilearea.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ["dragenter", "dragover"].forEach((eventName) => {
        dropArea_tilearea.addEventListener(
          eventName,
          () => dropArea_tilearea.classList.add("highlight"),
          false
        );
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropArea_tilearea.addEventListener(
          eventName,
          () => dropArea_tilearea.classList.remove("highlight"),
          false
        );
      });

      dropArea_tilearea.addEventListener("drop", handleTileAreaDrop, false);

      function handleTileAreaDrop(e) {
        let dt = e.dataTransfer;
        let files = dt.files;
        handleTileAreaFiles(files);
      }

      function handleTileAreaFiles(files) {
        files = [...files];
        filesToUpload_tilearea.push(...files);
        initializeTileAreaGallery(files);
      }

      function initializeTileAreaGallery(files) {
        let gallery_tilearea = document.getElementById("gallery-tilearea");
        gallery_tilearea.innerHTML = "";
        files.forEach((file) => {
          let img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          gallery_tilearea.appendChild(img);
        });
      }

      function uploadTileAreaFiles() {
        let formData = new FormData();
        filesToUpload_tilearea.forEach((file) => {
          formData.append("files[]", file);
        });

        fetch("{{ url_for('main.upload_tilefiles') }}", {
          method: "POST",
          body: formData,
        }).then((response) => {
          if (response.ok) {
            window.location.href = "{{ url_for('main.mosaify') }}";
          } else {
            alert("Error uploading files");
          }
        });
      }
    </script>
    <!-- End Tile Images -->

    <!-- Start Target Images -->
    <script>
      let dropArea_targetarea = document.getElementById("drop-area-targetarea");
      let filesToUpload_targetarea = [];

      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropArea_targetarea.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ["dragenter", "dragover"].forEach((eventName) => {
        dropArea_targetarea.addEventListener(
          eventName,
          () => dropArea_targetarea.classList.add("highlight"),
          false
        );
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropArea_targetarea.addEventListener(
          eventName,
          () => dropArea_targetarea.classList.remove("highlight"),
          false
        );
      });

      dropArea_targetarea.addEventListener("drop", handleTargetAreaDrop, false);

      function handleTargetAreaDrop(e) {
        let dt = e.dataTransfer;
        let files = dt.files;
        handleTargetAreaFiles(files);
      }

      function handleTargetAreaFiles(files) {
        files = [...files];
        // filesToUpload_targetarea.push(...files);
        // initializeTargetAreaGallery(files);

        // Check if there are any files
        if (files.length > 0) {
          // Get the first file
          const firstFile = files[0];

          // Add the first file to the filesToUpload_targetarea array
          filesToUpload_targetarea.push(firstFile);

          // Initialize the gallery with the first file
          initializeTargetAreaGallery([firstFile]);
        }
      }

      function initializeTargetAreaGallery(files) {
        let gallery_targetarea = document.getElementById("gallery-targetarea");
        gallery_targetarea.innerHTML = "";
        files.forEach((file) => {
          let img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          gallery_targetarea.appendChild(img);
        });
      }

      function uploadTargetAreaFiles() {
        let formData = new FormData();
        filesToUpload_targetarea.forEach((file) => {
          formData.append("files[]", file);
        });

        fetch("{{ url_for('main.upload_targetfiles') }}", {
          method: "POST",
          body: formData,
        }).then((response) => {
          if (response.ok) {
            window.location.href = "{{ url_for('main.mosaify') }}";
          } else {
            alert("Error uploading files");
          }
        });
      }
    </script>
    <!-- End Target Images -->
  </body>
</html>
